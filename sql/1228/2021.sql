WITH
  query AS (
  SELECT
    GLOBALEVENTID,
    MonthYear,
    CASE
      WHEN Actor1CountryCode = 'CHN' THEN Actor1CountryCode
    ELSE
    Actor2CountryCode
  END
    AS Actor1CountryCode,
    CASE
      WHEN Actor2CountryCode = 'CHN' THEN Actor1CountryCode
    ELSE
    Actor2CountryCode
  END
    AS Actor2CountryCode,
    QuadClass,
    EventCode,
    Actor1Code,
    Actor2Code,
    GoldsteinScale,
    AvgTone,
    SOURCEURL,
    IsRootEvent,
    YEAR
  FROM
    `gdelt-bq.full.events`
  WHERE
    YEAR = 2021
    AND GoldsteinScale < 0
    AND AvgTone < 0
    AND ( ( Actor1CountryCode = 'CHN'
        AND Actor2CountryCode IN ( 'USA',
          'AFG',
          'AGO',
          'ARE',
          'ARG',
          'ARM',
          'ATG',
          'AUS',
          'AUT',
          'AZE',
          'BEL',
          'BGD',
          'BGR',
          'BHR',
          'BIH',
          'BLR',
          'BMU',
          'BOL',
          'BRA',
          'BRN',
          'BWA',
          'CAN',
          'CHE',
          'CHL',
          'CMR',
          'COD',
          'COG',
          'COL',
          'CRI',
          'CUB',
          'CYM',
          'CYP',
          'CZE',
          'DEU',
          'DJI',
          'DNK',
          'DOM',
          'DZA',
          'ECU',
          'EGY',
          'ESP',
          'EST',
          'ETH',
          'FIN',
          'FJI',
          'FRA',
          'FSM',
          'GAB',
          'GBR',
          'GEO',
          'GHA',
          'GIN',
          'GNB',
          'GRC',
          'GUY',
          'HKG',
          'HND',
          'HRV',
          'HTI',
          'HUN',
          'IDN',
          'IND',
          'IRL',
          'IRN',
          'IRQ',
          'ISL',
          'ISR',
          'ITA',
          'JAM',
          'JOR',
          'JPN',
          'KAZ',
          'KEN',
          'KGZ',
          'KHM',
          'KOR',
          'KWT',
          'LAO',
          'LBN',
          'LBR',
          'LKA',
          'LTU',
          'LUX',
          'LVA',
          'MAC',
          'MAR',
          'MDA',
          'MDG',
          'MEX',
          'MKD',
          'MLI',
          'MLT',
          'MMR',
          'MNE',
          'MNG',
          'MOZ',
          'MUS',
          'MWI',
          'MYS',
          'NAM',
          'NER',
          'NGA',
          'NIC',
          'NLD',
          'NOR',
          'NPL',
          'NZL',
          'OMN',
          'PAK',
          'PAN',
          'PER',
          'PHL',
          'PNG',
          'POL',
          'PRK',
          'PRT',
          'PRY',
          'QAT',
          'RUS',
          'RWA',
          'SAU',
          'SDN',
          'SEN',
          'SGP',
          'SLE',
          'SLV',
          'SOM',
          'SRB',
          'SUR',
          'SVK',
          'SVN',
          'SWE',
          'SYR',
          'TCD',
          'TGO',
          'THA',
          'TJK',
          'TKM',
          'TTO',
          'TUN',
          'TUR',
          'TZA',
          'UGA',
          'UKR',
          'URY',
          'UZB',
          'VEN',
          'VUT',
          'YEM',
          'ZAF',
          'ZMB',
          'VNM',
          'ROM',
          'ZWE' ) )
      OR ( Actor2CountryCode = 'CHN'
        AND Actor1CountryCode IN ( 'USA',
          'AFG',
          'AGO',
          'ARE',
          'ARG',
          'ARM',
          'ATG',
          'AUS',
          'AUT',
          'AZE',
          'BEL',
          'BGD',
          'BGR',
          'BHR',
          'BIH',
          'BLR',
          'BMU',
          'BOL',
          'BRA',
          'BRN',
          'BWA',
          'CAN',
          'CHE',
          'CHL',
          'CMR',
          'COD',
          'COG',
          'COL',
          'CRI',
          'CUB',
          'CYM',
          'CYP',
          'CZE',
          'DEU',
          'DJI',
          'DNK',
          'DOM',
          'DZA',
          'ECU',
          'EGY',
          'ESP',
          'EST',
          'ETH',
          'FIN',
          'FJI',
          'FRA',
          'FSM',
          'GAB',
          'GBR',
          'GEO',
          'GHA',
          'GIN',
          'GNB',
          'GRC',
          'GUY',
          'HKG',
          'HND',
          'HRV',
          'HTI',
          'HUN',
          'IDN',
          'IND',
          'IRL',
          'IRN',
          'IRQ',
          'ISL',
          'ISR',
          'ITA',
          'JAM',
          'JOR',
          'JPN',
          'KAZ',
          'KEN',
          'KGZ',
          'KHM',
          'KOR',
          'KWT',
          'LAO',
          'LBN',
          'LBR',
          'LKA',
          'LTU',
          'LUX',
          'LVA',
          'MAC',
          'MAR',
          'MDA',
          'MDG',
          'MEX',
          'MKD',
          'MLI',
          'MLT',
          'MMR',
          'MNE',
          'MNG',
          'MOZ',
          'MUS',
          'MWI',
          'MYS',
          'NAM',
          'NER',
          'NGA',
          'NIC',
          'NLD',
          'NOR',
          'NPL',
          'NZL',
          'OMN',
          'PAK',
          'PAN',
          'PER',
          'PHL',
          'PNG',
          'POL',
          'PRK',
          'PRT',
          'PRY',
          'QAT',
          'RUS',
          'RWA',
          'SAU',
          'SDN',
          'SEN',
          'SGP',
          'SLE',
          'SLV',
          'SOM',
          'SRB',
          'SUR',
          'SVK',
          'SVN',
          'SWE',
          'SYR',
          'TCD',
          'TGO',
          'THA',
          'TJK',
          'TKM',
          'TTO',
          'TUN',
          'TUR',
          'TZA',
          'UGA',
          'UKR',
          'URY',
          'UZB',
          'VEN',
          'VUT',
          'YEM',
          'ZAF',
          'ZMB',
          'VNM',
          'ROM',
          'ZWE' ) ) )
     )
SELECT
  *
FROM
  query AS A
WHERE
  EXISTS(
  SELECT
    1
  FROM (
    SELECT
      ARRAY_AGG(DISTINCT (CASE
            WHEN AC IN ('TWN', 'HKG', 'MAC') OR AC IS NULL THEN 'CHN'
          ELSE
          AC
        END
          )) AS AC_agg,
      SOURCEURL
    FROM
      `gdelt-bq.full.events` UNPIVOT(AC FOR type IN(Actor1CountryCode,
          Actor2CountryCode))
    WHERE
      YEAR = 2021
    GROUP BY SOURCEURL ) AS T
  WHERE
    A.Actor1CountryCode IN UNNEST(T.AC_agg)
    AND A.Actor2CountryCode IN UNNEST(T.AC_agg)
    AND ARRAY_LENGTH(AC_agg) <= 2
    AND A.SOURCEURL = T.SOURCEURL )